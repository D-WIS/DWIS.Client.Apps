@inject BlackBoardExplorer BBExplorer
@inject IOPCUADWISClient DWISClient
@using System.Collections.Concurrent
@using DWIS.SPARQL.Utils


<MudDrawerContainer Class="mud-height-full">
    <MudDrawer @bind-Open="DrawerOpen" Variant="@DrawerVariant.Persistent" Fixed Width="400px">
        <MudDrawerHeader>
            <MudTextField @bind-Value="_searchString"  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable DebounceInterval="500" OnDebounceIntervalElapsed="UpdateProviders"></MudTextField>
        </MudDrawerHeader>
        <MudTreeView T="NodeIdentifier" SelectionMode="@SelectionMode.MultiSelection" @bind-SelectedValues="FocusItems" Hover>
            <MudTreeViewItem Icon="@Icons.Material.Filled.People" Text="Providers"  Expanded>
                
                @foreach (var provider in Providers)
                {
                    <MudTreeViewItem Style=" font-weight:500; font-size:small"  Text="@DisplayProviderString(provider)" Context="variables" Value="@provider">
                            @foreach (var variable in BBExplorer.GetSignalsForProvider(provider))
                            {
                                <MudTreeViewItem  Style=" font-weight:300; font-size:small" Text="@DisplayVariableString(variable)" Value="@variable">
                  
                                </MudTreeViewItem>
                            }
           
                    </MudTreeViewItem>
                }

            </MudTreeViewItem>
        </MudTreeView>
    </MudDrawer>
        <MudPaper Width="100%">
           
            <MudTable Items="_monitorData" Style="width:100%" >
                <HeaderContent>
                    <MudTh Style="font-weight: bold;">Variable</MudTh>
                    <MudTh Style="font-weight: bold;">Value</MudTh>
                    <MudTh Style="font-weight: bold;">Sentences</MudTh>
                    <MudTh Style="font-weight: bold;">Remove</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd Style="font-style:italic; ">@DisplayVariableString(context.Key)</MudTd>
                    <MudTd Style="color:darkblue">@context.Value.Value</MudTd>
                    <MudTd>
                        <MudExpansionPanel Text="@((context.Value.Sentences != null?   context.Value.Sentences.Count.ToString() : "0") + " sentence(s)")">
                            <MudTable Bordered Context="sentence" Items="context.Value.Sentences" >
                                <HeaderContent>
                                    <MudTh Style="font-weight: bold;">Verb</MudTh>
                                    <MudTh Style="font-weight: bold;">Object</MudTh>
                                </HeaderContent>
                                <RowTemplate >
                                    <MudTd>
                                       @DisplaySentenceVerb(sentence.v)
                                    </MudTd>
                                    <MudTd>
                                        @DisplaySentenceObject(sentence.o)
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudExpansionPanel>
                    </MudTd>
                    <MudTd>
                        <MudButton StartIcon="@Icons.Material.Filled.Delete" IconColor="Color.Error" Variant="Variant.Filled" Size="Size.Small" OnClick="@(() => FocusItems = FocusItems.Where(item => item != context.Key).ToList())"></MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>


</MudDrawerContainer>

@code {
    [Parameter]
    public bool DrawerOpen { get; set; }

    private ConcurrentDictionary<NodeIdentifier, MonitorData> _monitorData = new();

    private IReadOnlyCollection<NodeIdentifier> FocusItems = new List<NodeIdentifier>();

    private List<NodeIdentifier> Providers = new List<NodeIdentifier>();

    private string _searchString = string.Empty;

    protected override Task OnInitializedAsync()
    {
        UpdateProviders(_searchString);
        return base.OnInitializedAsync();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Task.Run(DisplayLoop);
        }
        base.OnAfterRender(firstRender);
    }

    private async Task DisplayLoop()
    {
        PeriodicTimer timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        bool looping = false;
        while(await timer.WaitForNextTickAsync())
        {
            if (!looping)
            {
                looping = true;
                ManageMonitorData();
                if (_monitorData.Any())
                {
                    var originalKeys = _monitorData.Keys.ToArray();
                    var keys = originalKeys.Select(key => (key.NameSpace, key.ID)).ToArray();
                    if (DWISClient.ReadAnyVariables(out object[] values, keys))
                    {
                        foreach (var (key, value) in originalKeys.Zip(values, (k, v) => (k, v)))
                        {
                            if (_monitorData.TryGetValue(key, out var data))
                            {
                                data.Value = value;
                            }
                        }
                    }
                }
                await InvokeAsync(StateHasChanged);
                looping = false;
            }
        }
    }

    private string DisplaySentenceVerb(NodeIdentifier v)
    {
        if (v.ID.StartsWith(QueryBuilder.DDHUBPREFIX))
        { return v.ID.Remove(0, QueryBuilder.DDHUBPREFIX.Length); }
        else if (v.ID.StartsWith(QueryBuilder.RDFTYPE))
        {
            return v.ID.Remove(0, QueryBuilder.RDFTYPE.Length);
        }
        else if (v.ID.StartsWith("http://ddhub.no/"))
        {
            return v.ID.Remove(0, "http://ddhub.no/".Length);
        }
        else if (v.ID.Contains("#type"))
        {
            return "type";    
        }
        else { return v.ID; }
    }

    private string DisplaySentenceObject(NodeIdentifier v)
    {
        if (v == null) { return "_"; }
        string ns = v.NameSpace;
        if (ns.StartsWith(QueryBuilder.DDHUBPREFIX))
        { ns = ns.Remove(0, QueryBuilder.DDHUBPREFIX.Length); }
        else if (ns.StartsWith(QueryBuilder.RDFTYPE))
        {
            ns = ns.Remove(0, QueryBuilder.RDFTYPE.Length);
        }
        else if (ns.StartsWith("http://ddhub.no/"))
        {
            ns = ns.Remove(0, "http://ddhub.no/".Length);
        }
        string id = v.ID;
        if (id.StartsWith(QueryBuilder.DDHUBPREFIX))
        {
            id = id.Remove(0, QueryBuilder.DDHUBPREFIX.Length);
        }
        else if (id.StartsWith("http://ddhub.no/"))
        {
            id = id.Remove(0, "http://ddhub.no/".Length);
        }
        return ns + id;
    }

    private void UpdateProviders(string searchValue)
    {
        if (string.IsNullOrEmpty(_searchString))
        {
            Providers = BBExplorer.GetProviders();
        }
        else
        {
            Providers = BBExplorer.GetProviders().Where((p) => p.ID.Contains(_searchString, StringComparison.OrdinalIgnoreCase) || p.NameSpace.Contains(_searchString, StringComparison.OrdinalIgnoreCase)).ToList();
        }
    }

    private string DisplayProviderString(NodeIdentifier nodeIdentifier)
    {
        if (nodeIdentifier.NameSpace.StartsWith("http://ddhub.no/"))
        {
            return nodeIdentifier.NameSpace.Remove(0, "http://ddhub.no/".Length) + " " + nodeIdentifier.ID;
        }
        else return nodeIdentifier.ID;
    }
    private string DisplayVariableString(NodeIdentifier nodeIdentifier)
    {
        return  nodeIdentifier.ID;
    }

    private void ManageMonitorData()
    {
        var monitoredKeys = _monitorData.Keys;    
        var selectedKeys = FocusItems;

        var toAddToMonitor = selectedKeys.Except(monitoredKeys);
        var toRemoveFromMonitor = monitoredKeys.Except(selectedKeys);
        foreach (var key in toRemoveFromMonitor)
        {
            _monitorData.TryRemove(key, out _);
        }

        foreach(var key in toAddToMonitor)
        {
            _monitorData.TryAdd(key, Generate(key));
        }
    }

    private MonitorData Generate(NodeIdentifier nodeIdentifier)
    {
        var data = new MonitorData();
        var sentences = BBExplorer.GetSentences(nodeIdentifier);
        if (sentences != null)
        {
            data.Sentences = sentences.ToList();
        }
        return data;
    }

    public class MonitorData
    {
        public object? Value { get; set; }
        public List<(NodeIdentifier s, NodeIdentifier v, NodeIdentifier o)> Sentences = new();

    }
}
